# Lecture 2

Давайте порешаем задачи на фильтрацию данных и научимся применять оператор WHERE в сочетании с логическими выражениями.

Представьте, что из общего списка наименований товаров нам вдруг понадобилось отобрать определённые позиции. Но как это сделать? Неужели нам придётся просматривать всю таблицу, вручную составлять список товаров и писать длинное логическое выражение?

Разумеется, не придётся. Для фильтрации по колонкам с текстовыми значениями в SQL предусмотрен оператор LIKE.

Оператор LIKE не просто сравнивает строки на полное совпадение (или несовпадение), а проверяет их на соответствие заданному шаблону: если строка ему соответствует, то возвращается TRUE, в противном случае — FALSE. Как можно догадаться, конструкция NOT LIKE будет работать с точностью до наоборот.

Шаблоны могут содержать как обычные символы, так и символы-шаблоны: знак процента ( % ) и подчёркивание ( \_ ). Подчёркивание подменяет любой одиночный символ, а знак процента — любую (в том числе и пустую) последовательность символов:

```sql
SELECT 'karpov.courses' LIKE 'karpov%'

Результат:
true

SELECT 'karpov.courses' LIKE 'karpov_'

Результат:
false

SELECT 'karpov.courses' LIKE '%karpov%'

Результат:
true

SELECT 'karpov.courses' LIKE '_karpov%'

Результат:
false

SELECT 'karpov.courses' LIKE '%.%'

Результат:
true

SELECT 'karpov.courses' LIKE '_._'

Результат:
false

SELECT 'karpov.courses' LIKE 'Karpov%'

Результат:
false
```

Обратите внимание на последний пример: оператор LIKE чувствителен к регистру.

Если шаблон не содержит знаков процента и подчёркиваний, тогда шаблон представляет собой строку и LIKE работает как оператор сравнения, проверяя строки на точное совпадение.

```sql
SELECT 'karpov.courses' LIKE 'karpov.courses'

Результат:
true

SELECT 'karpov.courses' LIKE 'karpov'

Результат:
false
```

На заметку:

Подробнее про оператор LIKE и шаблоны можно почитать здесь https://www.postgresqltutorial.com/postgresql-tutorial/postgresql-like/

Представьте, что накануне Нового года к вам обратился менеджер, которому в голову пришла идея сделать скидку на самый дорогой чай. Он попросил вас предоставить ему выгрузку из базы данных со всеми чаями и новыми ценами на них с учётом скидки. Что он будет дальше делать с этими данными, вам не известно, но задача есть задача, к тому же не такая уж и сложная. Давайте попробуем её решить!
Пояснение:

Чтобы создать столбец с одним значением для всех записей (в нашем случае это столбец со скидкой), достаточно просто ввести нужное значение и как-то назвать новый столбец — указанное значение автоматически проставится во всех строках.

Но что если мы всё-таки не хотим проверять наши данные на соответствие какому-то шаблону, а просто хотим отобрать значения из некоторого списка или даже диапазона? В этом случае в логическом выражении после ключевого слова WHERE можно использовать операторы IN и BETWEEN.

Оператор IN проверяет, соответствует ли значение в колонке одному из значений из заданного списка (иными словами, проверяет, входит ли значение в этот список):

WHERE product_name IN (product_1, product_2, product_3, ...)

В свою очередь оператор BETWEEN позволяет отобрать данные, относящиеся к некоторому интервалу. При этом границы интервала включаются:

WHERE value BETWEEN 5 AND 10

Оператор BETWEEN можно использовать и для фильтрации по колонкам с датами и временем:

WHERE date BETWEEN '2022-11-10' AND '2022-12-10'

Однако в этом случае важно учитывать, что дата всегда интерпретируется как полночь (начало дня), т.е. '2022-12-10' в действительности означает '2022-12-10 00:00:00+00000'. Таким образом в заданный выше интервал не попадут записи позже полуночи 2022-12-10.

Для получения обратного результата в сочетании с операторами IN и BETWEEN можно использовать оператор NOT:

WHERE product_name NOT IN (product_1, product_2, product_3, ...)

WHERE value NOT BETWEEN 5 AND 10

На заметку:

Подробнее про операторы IN и BETWEEN можно прочитать здесь и здесь.

На прошлом уроке мы столкнулись с пропущенными значениями в таблице couriers — у некоторых курьеров не был указан их день рождения. Для проверки на NULL значения в SQL есть оператор IS NULL. В сочетании с WHERE записывается он так:

WHERE value IS NULL

Если же, наоборот, необходимо отобрать не NULL значения, то дополнительно используется оператор NOT:

WHERE value IS NOT NULL

Важно понимать, что в мире данных NULL означает отсутствие информации. NULL — это не какая-то величина, и поэтому её нельзя сравнить с чем-либо ещё. Результатом сравнения NULL с любым другим значением будет тот же NULL. Кроме того, NULL не получится сравнить и с другим NULL, потому что в таком случае будут сравниваться две неопределённости и нельзя наверняка сказать, равны они или нет.

Попробуйте самостоятельно запустить в Redash следующие запросы и посмотрите на их результат:

```sql
SELECT NULL = NULL
-- empty
SELECT NULL IS NULL
-- true
SELECT 1 = NULL
-- empty
SELECT 1 IS NULL
-- false
```

На заметку:

Подробнее про NULL значения можно прочитать здесь https://www.postgresqltutorial.com/postgresql-tutorial/postgresql-is-null/.

Для решения задачи вам может пригодиться функция DATE_PART. Для получения дня недели можно указать аргумент 'dow' (day of week). В PostreSQL дни недели считаются с воскресенья (0) до субботы (6). Будьте аккуратны при работе со временем.

## Подведём итоги

В этом уроке мы:

Научились фильтровать данные и применять логические выражения в блоке WHERE.
Познакомились с операторами IN и BETWEEN.
Узнали ещё больше о NULL значениях и научились их отбирать с помощью IS NULL.
Ещё немного поработали с датами и временем.
Совместили новые знания с информацией из прошлого урока и решили большую задачу на CASE.
Но поверьте, всё только начинается. Дальше будет ещё интереснее!
